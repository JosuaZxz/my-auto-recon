name: Sniper Recon (Supreme Edition)

on:
  schedule:
    - cron: '*/10 * * * *' # Nembak tiap 10 menit agar agresif
  workflow_dispatch:

jobs:
  recon-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20'

      - name: Install ProjectDiscovery Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python Dependencies
        run: pip install requests

      - name: Run Predator Recon
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          H1_USERNAME: ${{ secrets.H1_USERNAME }}
          H1_API_KEY: ${{ secrets.H1_API_KEY }}
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CRIT: ${{ secrets.TELEGRAM_CRITICAL_ID }}
          TG_GEN: ${{ secrets.TELEGRAM_GENERAL_ID }}
          TG_DATA: ${{ secrets.TELEGRAM_DATA_ID }}
        run: |
          # --- 1. PILIH TARGET (TEST MODE) ---
          # Baris bawah ini dipaksa ke 00_test untuk pengujian
          target_file="targets/hackerone.txt"
          program_name="hackerone"
          
          echo "=================================================="
          echo "ğŸ¯ TARGETING: $program_name"
          echo "â° START TIME: $(date)"
          echo "=================================================="
          
          mkdir -p "data/$program_name"

          # --- 2. LOGIKA KHUSUS MODE TEST API HACKERONE (PASTI BUNYI & MASUK DRAFT) ---
          # Kita pake nama program 'hackerone' karena ini handle asli di HackerOne
          target_file="targets/hackerone.txt"
          program_name="hackerone"
          
          echo "=================================================="
          echo "ğŸ¯ REAL API TESTING: $program_name"
          echo "=================================================="
          
          mkdir -p "data/$program_name"

          # SUNTIK BUG PALSU KE TARGET HACKERONE (Biar AI mau bikin draft asli)
          echo '{"template-id":"fake-critical-bug","info":{"severity":"critical"},"matched-at":"https://hackerone.com/test-logic","ip":"104.16.99.163"}' > "data/$program_name/nuclei_results.json"
          
          echo "[+] Running AI Validation (Real API Call to H1)..."
          PROGRAM_NAME=$program_name python scripts/validate.py
          
          # Kirim Notif ke Telegram (Grup Critical)
          if [ -f "data/$program_name/high_findings.txt" ]; then
            echo "[!] Sending Real Alert to Telegram..."
            MSG=$(cat data/$program_name/high_findings.txt)
            curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CRIT" -d "text=$MSG"
          fi
          
          # Kirim ZIP Database ke Telegram (Grup Data)
          zip -j "${program_name}_data.zip" data/$program_name/*
          curl -F chat_id="$TG_DATA" -F document=@"${program_name}_data.zip" -F caption="ğŸ“¦ REAL API TEST: $program_name" "https://api.telegram.org/bot$TG_TOKEN/sendDocument"
          rm -f "${program_name}_data.zip"
          
          echo "âœ… REAL API TEST COMPLETED."
          
          else
            # --- 3. LOGIKA BERBURU ASLI (REAL HUNTING) ---
            
            # A. SUBFINDER
            echo "[+] ğŸ” Step 1: Subfinder Starting..."
            timeout 30m subfinder -dL "$target_file" -all -silent -o "data/$program_name/subdomains.txt" > /dev/null 2>&1
            count_sub=$(wc -l < "data/$program_name/subdomains.txt" || echo 0)
            echo "    âœ… Subfinder Done: $count_sub subdomains."
            
            if [ "$count_sub" -gt 0 ]; then
              # B. HTTPX
              echo "[+] ğŸŒ Step 2: HTTPX Live Check Starting..."
              timeout 45m httpx -l "data/$program_name/subdomains.txt" -silent -ip -o "data/$program_name/active_hosts.txt" > /dev/null 2>&1
              count_live=$(wc -l < "data/$program_name/active_hosts.txt" || echo 0)
              echo "    âœ… HTTPX Done: $count_live target alive."
              
              if [ "$count_live" -gt 0 ]; then
                # C. NUCLEI
                echo "[+] â˜¢ï¸ Step 3: Nuclei Deep Scan (Progress shown every 60s)..."
                timeout 4h nuclei -l "data/$program_name/active_hosts.txt" -tags exposure,misconfig,takeover,cve,tech -c 50 -timeout 3 -retries 0 -stats -si 60 -silent -jsonl -o "data/$program_name/nuclei_results.json"
                echo "    âœ… Nuclei Done."
                
                # D. AI VALIDATION
                echo "[+] ğŸ§  Step 4: AI Analysis & Drafting..."
                PROGRAM_NAME=$program_name python scripts/validate.py
                
                # E. SEND ALERTS (Grup A & B)
                if [ -f "data/$program_name/high_findings.txt" ]; then
                  MSG=$(cat data/$program_name/high_findings.txt)
                  curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_CRIT" -d "text=$MSG"
                fi
                if [ -f "data/$program_name/low_findings.txt" ]; then
                  MSG=$(cat data/$program_name/low_findings.txt)
                  curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" -d "chat_id=$TG_GEN" -d "text=$MSG"
                fi

                # F. BACKUP DATABASE ZIP (Grup C)
                zip_name="${program_name}_data.zip"
                zip -j "$zip_name" data/$program_name/*
                curl -v -F chat_id="$TG_DATA" -F document=@"$zip_name" -F caption="ğŸ“¦ DATABASE: $program_name" "https://api.telegram.org/bot$TG_TOKEN/sendDocument"
                rm -f "$zip_name"
              fi
            fi
          fi

          echo "=================================================="
          echo "ğŸ MISSION FINISHED: $(date)"
          echo "=================================================="
