- name: Run Multi-Program Recon
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          NOTIFY_CONF: ${{ secrets.NOTIFY_CONFIG }}
        run: |
          # Loop semua file .txt di folder targets
          for target_file in targets/*.txt; do
            # Ambil nama program (misal: paypal dari targets/paypal.txt)
            program_name=$(basename "$target_file" .txt)
            echo "Processing program: $program_name"
            
            # Buat folder khusus untuk program tersebut
            mkdir -p "data/$program_name"
            
            # 1. Subfinder (mencari subdomain)
            subfinder -dL "$target_file" -all -o "data/$program_name/subdomains.txt"
            
            # 2. HTTPX (cek yang aktif)
            cat "data/$program_name/subdomains.txt" | httpx -silent -o "data/$program_name/active_hosts.txt"
            
            # 3. Nuclei (scan kerentanan)
            # Output disimpan dengan nama program agar AI tahu ini punya siapa
            nuclei -l "data/$program_name/active_hosts.txt" -t exposures,misconfiguration,vulnerabilities -jsonl -o "data/$program_name/nuclei_results.json"
            
            # 4. Jalankan AI Validation dengan passing Nama Program
            # Kita kirim nama program sebagai environment variable
            PROGRAM_NAME=$program_name python scripts/validate.py
            
            # 5. Kirim Notifikasi jika ada temuan AI
            if [ -f "data/$program_name/ai_findings.txt" ]; then
              echo "Sending notification for $program_name..."
              echo "$NOTIFY_CONF" > notify-config.yaml
              # Tambahkan label [PROGRAM NAME] di depan pesan
              echo -e "Target: $program_name\n$(cat data/$program_name/ai_findings.txt)" | notify -config notify-config.yaml
            fi
          done
