name: Automation Recon (24/7 Grandmaster)

on:
  schedule:
    - cron: '*/10 * * * *' # Jalan tiap 30 menit (Sangat Aman dari Ban)
  workflow_dispatch:

jobs:
  recon-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --- [MEMORI RAHASIA: ANTI-DUPLIKAT] ---
      - name: Restore/Save Seen URLs
        uses: actions/cache@v3
        with:
          path: .seen_urls
          key: seen-urls-cache-${{ github.run_id }}
          restore-keys: |
            seen-urls-cache-

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20'

      - name: Install Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install Python Dependencies
        run: pip install requests

      - name: Run Predator Recon
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          H1_USERNAME: ${{ secrets.H1_USERNAME }}
          H1_API_KEY: ${{ secrets.H1_API_KEY }}
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CRIT: ${{ secrets.TELEGRAM_CRITICAL_ID }}
          TG_GEN: ${{ secrets.TELEGRAM_GENERAL_ID }}
          TG_DATA: ${{ secrets.TELEGRAM_DATA_ID }}
        run: |
          # PILIH TARGET ACAK
          touch .seen_urls
          target_file=$(ls targets/*.txt | shuf | head -n 1)
          program_name=$(basename "$target_file" .txt)
          echo "ðŸŽ¯ TARGETING: $program_name"
          mkdir -p "data/$program_name"

          # SCANNING
          timeout 30m subfinder -dL "$target_file" -all -silent -o "data/$program_name/subdomains.txt" > /dev/null 2>&1 || true
          timeout 45m httpx -l "data/$program_name/subdomains.txt" -silent -ip -td -mc 200,401,403 -o "data/$program_name/active_hosts.txt" > /dev/null 2>&1 || true
          timeout 3h nuclei -l "data/$program_name/active_hosts.txt" -tags exposure,misconfig,takeover,cve2023,cve2024,cve2025 -severity critical,high,medium -nt -rl 80 -c 15 -me 10 -silent -jsonl -o "data/$program_name/nuclei_results.json" || true
          
          # AI ANALYSIS
          PROGRAM_NAME=$program_name python scripts/validate.py

          # KIRIM FILE LAPORAN KE TELEGRAM
          if [ -d "data/$program_name/alerts/high" ]; then
            for f in data/$program_name/alerts/high/*.md; do
              [ -e "$f" ] || continue
              curl -v -F chat_id="$TG_CRIT" -F document=@"$f" -F caption="ðŸš¨ [P1/P2 BUG] $program_name" "https://api.telegram.org/bot$TG_TOKEN/sendDocument"
            done
          fi
          if [ -d "data/$program_name/alerts/low" ]; then
            for f in data/$program_name/alerts/low/*.md; do
              [ -e "$f" ] || continue
              curl -v -F chat_id="$TG_GEN" -F document=@"$f" -F caption="âš ï¸ [P3/P4 BUG] $program_name" "https://api.telegram.org/bot$TG_TOKEN/sendDocument"
            done
          fi

          # BACKUP DATA ZIP
          zip -j "${program_name}_data.zip" data/$program_name/*.txt data/$program_name/*.json > /dev/null 2>&1 || true
          curl -F chat_id="$TG_DATA" -F document=@"${program_name}_data.zip" -F caption="ðŸ“¦ DATABASE: $program_name" "https://api.telegram.org/bot$TG_TOKEN/sendDocument"
